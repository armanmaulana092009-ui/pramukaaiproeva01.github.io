import React, { useState, useEffect, useRef } from 'react';
import { 
  Upload, ShieldCheck, Download, RefreshCw, AlertCircle, 
  CheckCircle2, Users, Layers, Trash2, Play, Check, 
  Archive, Palette, FileImage, Menu, Crop, ScanFace, 
  Sparkles, Wand2, Moon, Sun, X, Zap, ChevronRight, Image as ImageIcon,
  Cpu, Activity, Terminal, DownloadCloud, FileArchive
} from 'lucide-react';

const apiKey = ""; // Managed by environment

const App = () => {
  const [fileQueue, setFileQueue] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [selectedLevel, setSelectedLevel] = useState('Penggalang');
  const [editType, setEditType] = useState('full');
  const [bgColor, setBgColor] = useState('hijau');
  const [isDragging, setIsDragging] = useState(false);
  const [isZipping, setIsZipping] = useState(false);
  const processingRef = useRef(false);

  // Load JSZip dynamically
  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
    script.async = true;
    document.body.appendChild(script);
    document.documentElement.classList.add('dark');
    return () => {
      document.body.removeChild(script);
    };
  }, []);

  const levels = [
    { name: 'Siaga', ringPrompt: 'Green Metal Ring (Ring Kaleng Hijau) with Gold Tunas Kelapa emblem', color: '#16a34a' },
    { name: 'Penggalang', ringPrompt: 'Red Metal Ring (Ring Kaleng Merah) with Gold Tunas Kelapa emblem', color: '#dc2626' },
    { name: 'Penegak', ringPrompt: 'Yellow Metal Ring (Ring Kaleng Kuning) with Gold Tunas Kelapa emblem', color: '#eab308' },
    { name: 'Pembina', ringPrompt: 'Silver Metal Ring (Ring Kaleng Perak) with Gold Tunas Kelapa emblem', color: '#94a3b8' }
  ];

  const backgroundColors = [
    { id: 'hijau', name: 'Hijau', hex: '#00b140' },
    { id: 'merah', name: 'Merah', hex: '#db1514' },
    { id: 'biru', name: 'Biru', hex: '#0056b3' },
    { id: 'netral', name: 'Netral', hex: '#f5f5f4' },
  ];

  const processFiles = (files) => {
    const uploadedFiles = Array.from(files);
    uploadedFiles.forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onloadend = () => {
        if (typeof reader.result === 'string') {
          setFileQueue(prev => [...prev, {
            id: Math.random().toString(36).substr(2, 9),
            originalName: file.name,
            preview: reader.result,
            base64: reader.result.split(',')[1],
            status: 'READY',
            result: null
          }]);
        }
      };
      reader.readAsDataURL(file);
    });
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setIsDragging(false);
    processFiles(e.dataTransfer.files);
  };

  const processSingleFile = async (item) => {
    let bgPrompt = bgColor === 'hijau' ? "solid green screen background" : `solid ${bgColor} background`;
    const ringDetail = levels.find(l => l.name === selectedLevel)?.ringPrompt || "standard scout ring";
    
    // Logic updated for collar-aware placement
    const prompt = `High-end studio photography, 4k resolution. 
      Core Task: Change background to ${bgPrompt}. 
      Mandatory Attire & Placement: ${editType === 'full' 
        ? 'Indonesian Scout Uniform (Seragam Pramuka Cokelat), with a Red-and-White Scout Scarf (Kacu Merah Putih) worn around the neck.' 
        : 'Keep the original clothes. Add a Red-and-White Scout Scarf (Kacu Merah Putih) around the neck. If the original clothing has a collar (kerah), the scarf MUST be placed neatly tucked UNDER the collar (diletakkan di bawah kerah) so the collar remains visible on top of the scarf edges.'}. 
      Specific Accessory: Add a ${ringDetail} to secure the scarf at the center of the chest. 
      Color Accuracy: The scarf MUST be strictly Red and White (half red, half white), vibrant and clean. 
      Final Polish: Cinematic lighting, professional retouching, maintaining person's facial features accurately with realistic fabric textures.`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: item.base64 } }] }],
          generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
        })
      });
      const result = await response.json();
      const base64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
      return base64 ? { status: 'COMPLETE', result: `data:image/png;base64,${base64}` } : { status: 'ERROR', error: 'AI Error' };
    } catch (e) {
      return { status: 'ERROR', error: e.message };
    }
  };

  const startBatch = async () => {
    setIsProcessing(true);
    processingRef.current = true;
    for (const item of fileQueue) {
      if (item.status === 'COMPLETE' || !processingRef.current) continue;
      setFileQueue(q => q.map(i => i.id === item.id ? { ...i, status: 'SYNCING' } : i));
      const res = await processSingleFile(item);
      setFileQueue(q => q.map(i => i.id === item.id ? { ...i, ...res } : i));
    }
    setIsProcessing(false);
  };

  const handleZipDownload = async () => {
    if (typeof JSZip === 'undefined') {
      console.error('JSZip not loaded yet');
      return;
    }

    setIsZipping(true);
    const zip = new JSZip();
    const completedItems = fileQueue.filter(item => item.status === 'COMPLETE' && item.result);

    completedItems.forEach((item) => {
      const base64Data = item.result.split(',')[1];
      // Updated: Use originalName directly without prefix
      zip.file(item.originalName, base64Data, { base64: true });
    });

    try {
      const content = await zip.generateAsync({ type: "blob" });
      const url = window.URL.createObjectURL(content);
      const link = document.createElement('a');
      link.href = url;
      link.download = `PramukaAI_Batch_${new Date().getTime()}.zip`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error("ZIP Generation failed", err);
    } finally {
      setIsZipping(false);
    }
  };

  const hasCompletedFiles = fileQueue.some(item => item.status === 'COMPLETE');

  return (
    <div 
      onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
      onDragLeave={() => setIsDragging(false)}
      onDrop={handleDrop}
      className="min-h-screen transition-all duration-500 font-mono bg-[#0a0510] text-[#ccff00] selection:bg-[#ccff00]/30 overflow-x-hidden"
    >
      <div className="fixed inset-0 pointer-events-none opacity-20">
        <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_50%_50%,#4c1d95_0%,transparent_70%)]"></div>
        <div className="absolute inset-0 bg-[linear-gradient(rgba(204,255,0,0.05)_1px,transparent_1px),linear-gradient(90deg,rgba(204,255,0,0.05)_1px,transparent_1px)] bg-[size:40px_40px]"></div>
      </div>

      <nav className="fixed top-0 w-full z-50 px-6 py-4 flex items-center justify-between backdrop-blur-md border-b border-[#ccff00]/20 bg-[#0a0510]/80">
        <div className="flex items-center gap-5 group cursor-default">
          <div className="relative">
            <div className="absolute -inset-2 bg-[#ccff00]/20 blur-lg group-hover:bg-[#ccff00]/40 transition duration-500"></div>
            <div className="relative border-2 border-[#ccff00] p-1.5 bg-[#4c1d95] shadow-[0_0_10px_#ccff00]">
              <Terminal className="w-5 h-5 text-[#ccff00]" />
            </div>
          </div>
          <div className="relative">
            <h1 className="text-2xl font-black tracking-[-0.05em] uppercase italic leading-none">
              PRAMUKA<span className="text-white drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]">AI</span>
              <span className="ml-1 px-1 bg-[#ccff00] text-black not-italic text-sm align-top shadow-[2px_2px_0_#4c1d95]">PRO</span>
            </h1>
            <div className="flex items-center gap-1 mt-1 opacity-60">
              <div className="h-[2px] w-8 bg-[#ccff00]"></div>
              <div className="text-[7px] font-bold tracking-[0.5em] text-[#ccff00] uppercase">Neural Pilot Interface</div>
            </div>
          </div>
        </div>

        <div className="flex items-center gap-6">
          <div className="hidden md:flex flex-col items-end border-r border-[#ccff00]/20 pr-6">
            <div className="text-[10px] font-bold text-[#ccff00]/40">CORE SYNC</div>
            <div className="text-[10px] font-black text-[#ccff00] flex items-center gap-2">
              <span className="w-2 h-2 rounded-full bg-[#ccff00] animate-pulse"></span>
              98.4% STABLE
            </div>
          </div>
          {fileQueue.length > 0 && (
            <button onClick={() => setFileQueue([])} className="group flex items-center gap-2 text-[10px] font-bold text-red-500 hover:text-red-400 transition-colors uppercase border border-red-500/30 px-3 py-1 bg-red-500/5">
              <Trash2 className="w-3 h-3" /> Purge Memory
            </button>
          )}
        </div>
      </nav>

      <main className="pt-28 pb-20 px-6 max-w-[1600px] mx-auto grid lg:grid-cols-[380px_1fr] gap-8 relative z-10">
        <section className="space-y-6">
          <div className="p-6 rounded-none border-2 border-[#ccff00]/30 bg-[#1a0b2e] relative shadow-[0_0_15px_rgba(76,29,149,0.5)]">
            <div className="absolute -top-1 -left-1 w-4 h-4 border-t-2 border-l-2 border-[#ccff00]"></div>
            <div className="absolute -bottom-1 -right-1 w-4 h-4 border-b-2 border-r-2 border-[#ccff00]"></div>

            <header className="flex items-center justify-between mb-8 border-b border-[#ccff00]/10 pb-4">
              <div className="flex items-center gap-2">
                <Cpu className="w-4 h-4 text-[#ccff00]" />
                <h2 className="text-[10px] font-black uppercase tracking-widest">Operation L-01</h2>
              </div>
              <div className="text-[8px] px-2 py-0.5 bg-[#ccff00] text-black font-bold animate-pulse">RE-DRAFT</div>
            </header>

            <div className="space-y-8">
              <div>
                <label className="text-[9px] font-black uppercase tracking-[0.2em] text-[#ccff00]/50 mb-3 block border-l-2 border-[#ccff00] pl-2">Sync Target</label>
                <div className="grid grid-cols-1 gap-2">
                  {[
                    { id: 'full', label: 'FULL BATTLE GEAR (SERAGAM)', icon: <Users className="w-3 h-3" /> },
                    { id: 'kacu', label: 'TACTICAL SCARF (KACU)', icon: <ShieldCheck className="w-3 h-3" /> }
                  ].map(btn => (
                    <button 
                      key={btn.id}
                      onClick={() => setEditType(btn.id)}
                      className={`flex items-center justify-between px-4 py-3 text-[10px] font-bold transition-all border ${editType === btn.id ? 'bg-[#ccff00] border-[#ccff00] text-black shadow-[0_0_15px_rgba(204,255,0,0.3)]' : 'bg-transparent border-[#ccff00]/20 text-[#ccff00]/60 hover:border-[#ccff00]/50'}`}
                    >
                      <span className="flex items-center gap-2">{btn.icon} {btn.label}</span>
                      {editType === btn.id && <div className="w-2 h-2 bg-black animate-ping"></div>}
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="text-[9px] font-black uppercase tracking-[0.2em] text-[#ccff00]/50 mb-3 block border-l-2 border-[#ccff00] pl-2">Pilot Rank</label>
                <div className="grid grid-cols-2 gap-2">
                  {levels.map(l => (
                    <button 
                      key={l.name}
                      onClick={() => setSelectedLevel(l.name)}
                      className={`relative p-3 border transition-all text-left group ${selectedLevel === l.name ? 'border-[#ccff00] bg-[#ccff00]/10 text-[#ccff00]' : 'border-white/5 bg-black/40 text-[#ccff00]/30 hover:border-[#ccff00]/30'}`}
                    >
                      <div className="text-[10px] font-black italic tracking-tighter">{l.name.toUpperCase()}</div>
                      <div className="absolute top-1 right-1 w-1 h-1 shadow-[0_0_5px_currentColor]" style={{ backgroundColor: l.color, color: l.color }}></div>
                      <div className={`absolute bottom-0 left-0 h-[1px] bg-[#ccff00] transition-all duration-300 ${selectedLevel === l.name ? 'w-full' : 'w-0'}`}></div>
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="text-[9px] font-black uppercase tracking-[0.2em] text-[#ccff00]/50 mb-3 block border-l-2 border-[#ccff00] pl-2">Field Chroma</label>
                <div className="flex gap-3">
                  {backgroundColors.map(bg => (
                    <button 
                      key={bg.id}
                      onClick={() => setBgColor(bg.id)}
                      className={`w-8 h-8 border-2 transition-all relative ${bgColor === bg.id ? 'border-[#ccff00] scale-110 shadow-[0_0_12px_rgba(204,255,0,0.6)]' : 'border-white/10 opacity-40 hover:opacity-100'}`}
                      style={{ backgroundColor: bg.hex }}
                    >
                      {bgColor === bg.id && <div className="absolute inset-0 border border-black/50"></div>}
                    </button>
                  ))}
                </div>
              </div>

              <div className="pt-4 space-y-3">
                <div className="relative group overflow-hidden">
                  <input type="file" multiple accept="image/*" onChange={(e) => processFiles(e.target.files)} className="absolute inset-0 opacity-0 cursor-pointer z-10" />
                  <div className="w-full py-6 border border-dashed border-[#ccff00]/20 bg-black/40 text-center group-hover:bg-[#4c1d95]/30 group-hover:border-[#ccff00]/50 transition-all">
                    <Upload className="w-5 h-5 text-[#ccff00] mx-auto mb-2 opacity-50 group-hover:opacity-100" />
                    <p className="text-[9px] font-bold uppercase tracking-widest text-[#ccff00]/40 group-hover:text-[#ccff00]">Awaiting Bio-Data</p>
                  </div>
                </div>

                <button 
                  onClick={startBatch}
                  disabled={isProcessing || fileQueue.length === 0}
                  className="w-full group relative py-4 bg-transparent border-2 border-[#ccff00] overflow-hidden transition-all disabled:opacity-20"
                >
                  <div className={`absolute inset-0 bg-[#ccff00] transition-transform duration-500 origin-left ${isProcessing ? 'scale-x-100' : 'scale-x-0 group-hover:scale-x-100'}`}></div>
                  <div className={`relative flex items-center justify-center gap-3 font-black text-[11px] tracking-[0.3em] uppercase transition-colors duration-500 ${isProcessing ? 'text-black' : 'text-[#ccff00] group-hover:text-black'}`}>
                    {isProcessing ? <RefreshCw className="w-4 h-4 animate-spin" /> : <><Zap className="w-4 h-4 fill-current" /> Execute Sync</>}
                  </div>
                </button>

                {hasCompletedFiles && (
                  <button 
                    onClick={handleZipDownload}
                    disabled={isZipping}
                    className="w-full group py-4 bg-[#ccff00]/10 border border-[#ccff00]/40 hover:bg-[#ccff00] transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                  >
                    {isZipping ? (
                        <RefreshCw className="w-4 h-4 text-[#ccff00] group-hover:text-black animate-spin" />
                    ) : (
                        <FileArchive className="w-4 h-4 text-[#ccff00] group-hover:text-black transition-colors" />
                    )}
                    <span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#ccff00] group-hover:text-black transition-colors">
                        {isZipping ? "Compressing Data..." : "Export as Archive (.ZIP)"}
                    </span>
                  </button>
                )}
              </div>
            </div>
          </div>

          <div className="p-3 border border-[#ccff00]/20 bg-black/40 text-[8px] font-bold text-[#ccff00]/60 uppercase tracking-tighter flex items-center gap-3">
            <div className="w-2 h-2 bg-red-500 animate-pulse"></div>
            <span>Restricted Access: Neural Pilot Synchronization Only</span>
          </div>
        </section>

        <section className="min-w-0">
          {fileQueue.length === 0 ? (
            <div className="h-full min-h-[550px] border border-[#ccff00]/10 bg-black/40 flex flex-col items-center justify-center text-center p-12 group relative overflow-hidden">
              <div className="absolute inset-0 flex items-center justify-center opacity-[0.05] pointer-events-none select-none">
                <div className="text-[15vw] font-black italic tracking-tighter">PROJECT-EVA</div>
              </div>
              <div className="relative mb-6">
                <div className="absolute -inset-10 bg-[#4c1d95]/20 rounded-full blur-3xl animate-pulse"></div>
                <div className="border border-[#ccff00]/30 p-10 bg-black/60 shadow-[0_0_30px_rgba(76,29,149,0.3)]">
                  <Activity className="w-16 h-16 text-[#ccff00]/20 group-hover:text-[#ccff00]/50 transition-colors duration-700" />
                </div>
              </div>
              <h3 className="text-2xl font-black tracking-widest mb-2 uppercase italic text-[#ccff00]/60">NO PILOT DETECTED</h3>
              <p className="text-[10px] font-bold text-[#ccff00]/30 uppercase tracking-[0.5em]">Upload biometric imagery to establish neural connection.</p>
            </div>
          ) : (
            <div className="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5">
              {fileQueue.map((item) => (
                <div 
                  key={item.id}
                  className="group relative border border-[#ccff00]/20 bg-black aspect-[3/4] overflow-hidden shadow-[0_0_20px_rgba(0,0,0,0.8)]"
                >
                  <img src={item.result || item.preview} className={`w-full h-full object-cover transition-all duration-1000 ${item.status === 'SYNCING' ? 'brightness-50 grayscale blur-sm' : ''}`} alt="Sync Data" />
                  
                  <div className="absolute inset-0 pointer-events-none opacity-20 bg-[linear-gradient(rgba(204,255,0,0.1)_1px,transparent_1px)] bg-[size:100%_4px]"></div>

                  {item.status === 'SYNCING' && (
                    <div className="absolute inset-0 z-20 flex flex-col items-center justify-center gap-3 bg-[#0a0510]/90 backdrop-blur-sm">
                      <div className="w-full px-10">
                        <div className="text-[8px] font-black text-[#ccff00] mb-1 tracking-[0.3em]">NEURAL LINK: ESTABLISHING</div>
                        <div className="h-1 bg-[#ccff00]/10 w-full overflow-hidden">
                          <div className="h-full bg-[#ccff00] animate-[shimmer_1.5s_infinite]"></div>
                        </div>
                      </div>
                      <span className="text-[10px] font-black tracking-[0.5em] uppercase text-[#ccff00] animate-pulse">Synchronizing...</span>
                    </div>
                  )}

                  <div className="absolute inset-0 z-10 bg-gradient-to-t from-[#4c1d95] via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-all p-5 flex flex-col justify-end">
                    <div className="flex gap-2">
                      <button onClick={() => setFileQueue(q => q.filter(i => i.id !== item.id))} className="p-2 border border-red-500 text-red-500 hover:bg-red-500 hover:text-white transition-all shadow-lg"><Trash2 className="w-4 h-4" /></button>
                      {item.status === 'COMPLETE' && (
                        <a href={item.result} download={item.originalName} className="flex-1 py-2 bg-[#ccff00] text-black text-[11px] font-black flex items-center justify-center gap-2 hover:bg-white transition-all shadow-lg">
                          <Download className="w-4 h-4" /> EXPORT DATA
                        </a>
                      )}
                    </div>
                  </div>

                  <div className="absolute top-3 left-3 text-[9px] font-bold text-[#ccff00] bg-black/60 px-2 py-0.5 border border-[#ccff00]/20">ID:{item.id.toUpperCase()}</div>
                  <div className={`absolute top-3 right-3 px-3 py-1 text-[9px] font-black italic tracking-widest shadow-xl ${item.status === 'COMPLETE' ? 'bg-[#ccff00] text-black' : 'bg-red-600 text-white'}`}>
                    {item.status}
                  </div>
                </div>
              ))}
            </div>
          )}
        </section>
      </main>

      <footer className="fixed bottom-0 w-full px-8 py-3 flex justify-between items-center text-[9px] font-bold text-[#ccff00]/30 uppercase tracking-[0.5em] pointer-events-none border-t border-[#ccff00]/10 bg-[#0a0510]/95">
        <div className="flex items-center gap-6">
          <div className="flex items-center gap-2">
            <div className="w-2 h-2 bg-[#ccff00] rounded-full"></div>
            <span>MAGI-01 SYSTEM: ONLINE</span>
          </div>
          <span className="hidden md:inline border-x border-[#ccff00]/10 px-6 italic">NEURAL ENGINE PRO v5.0.1</span>
        </div>
        <div className="flex items-center gap-2">SECURITY STATUS: <span className="text-[#ccff00]">ENCRYPTED</span></div>
      </footer>

      {isDragging && (
        <div className="fixed inset-0 z-[100] bg-[#4c1d95]/60 backdrop-blur-2xl flex items-center justify-center pointer-events-none p-12">
          <div className="w-full h-full border-4 border-[#ccff00] border-dashed flex flex-col items-center justify-center bg-black/60 shadow-[inset_0_0_100px_rgba(204,255,0,0.2)]">
            <Activity className="w-24 h-24 text-[#ccff00] animate-pulse mb-8" />
            <h2 className="text-6xl font-black italic tracking-tighter uppercase text-[#ccff00] drop-shadow-[0_0_20px_#ccff00]">BIO-DATA DETECTED</h2>
            <p className="text-[#ccff00]/60 tracking-[1.2em] uppercase text-sm mt-6 animate-bounce">Release to initiate neural link</p>
          </div>
        </div>
      )}

      <style>{`
        @keyframes shimmer {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(100%); }
        }
      `}</style>
    </div>
  );
};

export default App;