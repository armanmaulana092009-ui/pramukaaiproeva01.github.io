<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRAMUKA AI PRO - Neural Pilot Interface</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- JSZip for batch downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: 'JetBrains Mono', monospace; }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .animate-shimmer { animation: shimmer 1.5s infinite; }
        /* Custom scrollbar for cyberpunk look */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #0a0510; }
        ::-webkit-scrollbar-thumb { background: #ccff00; }
    </style>
</head>
<body class="bg-[#0a0510]">
    <div id="root"></div>

    <!-- React and Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Lucide Icons Wrapper for CDN
        const Icon = ({ name, className = "" }) => {
            const [icon, setIcon] = useState(null);
            useEffect(() => {
                if (window.lucide) {
                    const iconName = name.charAt(0).toUpperCase() + name.slice(1);
                    setIcon(window.lucide.icons[name] || window.lucide.icons['HelpCircle']);
                }
            }, [name]);
            
            if (!icon) return <div className={className}></div>;
            return <i data-lucide={name} className={className}></i>;
        };

        const apiKey = ""; // Managed by environment

        const App = () => {
            const [fileQueue, setFileQueue] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [selectedLevel, setSelectedLevel] = useState('Penggalang');
            const [editType, setEditType] = useState('full');
            const [bgColor, setBgColor] = useState('hijau');
            const [isDragging, setIsDragging] = useState(false);
            const [isZipping, setIsZipping] = useState(false);
            const processingRef = useRef(false);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [fileQueue, isProcessing]);

            const levels = [
                { name: 'Siaga', ringPrompt: 'Green Metal Ring (Ring Kaleng Hijau) with Gold Tunas Kelapa emblem', color: '#16a34a' },
                { name: 'Penggalang', ringPrompt: 'Red Metal Ring (Ring Kaleng Merah) with Gold Tunas Kelapa emblem', color: '#dc2626' },
                { name: 'Penegak', ringPrompt: 'Yellow Metal Ring (Ring Kaleng Kuning) with Gold Tunas Kelapa emblem', color: '#eab308' },
                { name: 'Pembina', ringPrompt: 'Silver Metal Ring (Ring Kaleng Perak) with Gold Tunas Kelapa emblem', color: '#94a3b8' }
            ];

            const backgroundColors = [
                { id: 'hijau', name: 'Hijau', hex: '#00b140' },
                { id: 'merah', name: 'Merah', hex: '#db1514' },
                { id: 'biru', name: 'Biru', hex: '#0056b3' },
                { id: 'netral', name: 'Netral', hex: '#f5f5f4' },
            ];

            const processFiles = (files) => {
                const uploadedFiles = Array.from(files);
                uploadedFiles.forEach(file => {
                    if (!file.type.startsWith('image/')) return;
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFileQueue(prev => [...prev, {
                            id: Math.random().toString(36).substr(2, 9),
                            originalName: file.name,
                            preview: reader.result,
                            base64: reader.result.split(',')[1],
                            status: 'READY',
                            result: null
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const startBatch = async () => {
                setIsProcessing(true);
                processingRef.current = true;
                const newQueue = [...fileQueue];
                
                for (let i = 0; i < newQueue.length; i++) {
                    const item = newQueue[i];
                    if (item.status === 'COMPLETE' || !processingRef.current) continue;

                    setFileQueue(q => q.map(it => it.id === item.id ? { ...it, status: 'SYNCING' } : it));
                    
                    const res = await processSingleFile(item);
                    setFileQueue(q => q.map(it => it.id === item.id ? { ...it, ...res } : it));
                }
                setIsProcessing(false);
            };

            const processSingleFile = async (item) => {
                const bgPrompt = bgColor === 'hijau' ? "solid green screen background" : `solid ${bgColor} background`;
                const ringDetail = levels.find(l => l.name === selectedLevel)?.ringPrompt || "standard scout ring";
                
                const prompt = `High-end studio photography, 4k resolution. Change background to ${bgPrompt}. ${editType === 'full' ? 'Indonesian Scout Uniform (Seragam Pramuka Cokelat), with a Red-and-White Scout Scarf (Kacu Merah Putih) worn around the neck.' : 'Keep original clothes. Add a Red-and-White Scout Scarf (Kacu Merah Putih) neatly UNDER the collar.'} Add a ${ringDetail} to secure the scarf.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: item.base64 } }] }],
                            generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
                        })
                    });
                    const result = await response.json();
                    const base64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    return base64 ? { status: 'COMPLETE', result: `data:image/png;base64,${base64}` } : { status: 'ERROR' };
                } catch (e) {
                    return { status: 'ERROR' };
                }
            };

            const handleZipDownload = async () => {
                setIsZipping(true);
                const zip = new JSZip();
                fileQueue.filter(i => i.status === 'COMPLETE').forEach(item => {
                    zip.file(item.originalName, item.result.split(',')[1], { base64: true });
                });
                const content = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `PramukaAI_Export.zip`;
                link.click();
                setIsZipping(false);
            };

            return (
                <div className="min-h-screen bg-[#0a0510] text-[#ccff00] selection:bg-[#ccff00]/30 overflow-x-hidden relative"
                     onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                     onDrop={(e) => { e.preventDefault(); setIsDragging(false); processFiles(e.dataTransfer.files); }}>
                    
                    {/* Background Grid */}
                    <div className="fixed inset-0 pointer-events-none opacity-20 bg-[linear-gradient(rgba(204,255,0,0.05)_1px,transparent_1px),linear-gradient(90deg,rgba(204,255,0,0.05)_1px,transparent_1px)] bg-[size:40px_40px]"></div>

                    {/* Nav */}
                    <nav className="fixed top-0 w-full z-50 px-6 py-4 flex items-center justify-between backdrop-blur-md border-b border-[#ccff00]/20 bg-[#0a0510]/80">
                        <div className="flex items-center gap-4">
                            <div className="border-2 border-[#ccff00] p-1 bg-[#4c1d95] shadow-[0_0_10px_#ccff00]">
                                <Icon name="terminal" className="w-5 h-5" />
                            </div>
                            <h1 className="text-xl font-black italic tracking-tighter">PRAMUKA<span className="text-white">AI</span> PRO</h1>
                        </div>
                        {fileQueue.length > 0 && (
                            <button onClick={() => setFileQueue([])} className="text-[10px] font-bold text-red-500 border border-red-500/30 px-3 py-1 bg-red-500/5">
                                PURGE MEMORY
                            </button>
                        )}
                    </nav>

                    <main className="pt-28 pb-20 px-6 max-w-7xl mx-auto grid lg:grid-cols-[350px_1fr] gap-8 relative z-10">
                        {/* Sidebar Controls */}
                        <aside className="space-y-6">
                            <div className="p-6 border-2 border-[#ccff00]/30 bg-[#1a0b2e] relative">
                                <label className="text-[9px] font-black uppercase tracking-widest text-[#ccff00]/50 mb-4 block">Neural Config</label>
                                
                                <div className="space-y-6">
                                    <div>
                                        <div className="grid grid-cols-1 gap-2">
                                            {['full', 'kacu'].map(t => (
                                                <button key={t} onClick={() => setEditType(t)} 
                                                    className={`p-3 text-[10px] font-bold border transition-all ${editType === t ? 'bg-[#ccff00] text-black border-[#ccff00]' : 'border-[#ccff00]/20 opacity-60 hover:opacity-100'}`}>
                                                    {t === 'full' ? 'FULL UNIFORM' : 'SCARF ONLY'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {levels.map(l => (
                                                <button key={l.name} onClick={() => setSelectedLevel(l.name)}
                                                    className={`p-2 text-[9px] font-bold border ${selectedLevel === l.name ? 'border-[#ccff00] bg-[#ccff00]/10' : 'border-white/5 opacity-50'}`}>
                                                    {l.name.toUpperCase()}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="pt-4 space-y-3">
                                        <div className="relative border border-dashed border-[#ccff00]/30 p-6 text-center hover:bg-[#ccff00]/5 transition-all">
                                            <input type="file" multiple accept="image/*" onChange={(e) => processFiles(e.target.files)} className="absolute inset-0 opacity-0 cursor-pointer" />
                                            <Icon name="upload" className="w-5 h-5 mx-auto mb-2 opacity-50" />
                                            <p className="text-[9px] font-bold opacity-40 uppercase tracking-widest">AWAITING BIO-DATA</p>
                                        </div>

                                        <button onClick={startBatch} disabled={isProcessing || fileQueue.length === 0}
                                            className="w-full py-4 bg-[#ccff00] text-black font-black text-[11px] tracking-[0.2em] disabled:opacity-20 flex items-center justify-center gap-2">
                                            {isProcessing ? <Icon name="refresh-cw" className="w-4 h-4 animate-spin" /> : 'EXECUTE SYNC'}
                                        </button>

                                        {fileQueue.some(i => i.status === 'COMPLETE') && (
                                            <button onClick={handleZipDownload} disabled={isZipping}
                                                className="w-full py-3 border border-[#ccff00] text-[#ccff00] font-bold text-[10px] flex items-center justify-center gap-2">
                                                {isZipping ? <Icon name="refresh-cw" className="w-3 h-3 animate-spin" /> : <Icon name="archive" className="w-3 h-3" />}
                                                EXPORT ARCHIVE
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </aside>

                        {/* Preview Area */}
                        <section>
                            {fileQueue.length === 0 ? (
                                <div className="h-96 border border-[#ccff00]/10 bg-black/40 flex flex-col items-center justify-center text-center">
                                    <Icon name="activity" className="w-12 h-12 opacity-20 mb-4" />
                                    <h3 className="text-sm font-bold opacity-30 tracking-[0.3em]">NO PILOT DETECTED</h3>
                                </div>
                            ) : (
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {fileQueue.map(item => (
                                        <div key={item.id} className="relative aspect-[3/4] bg-black border border-[#ccff00]/20 group overflow-hidden">
                                            <img src={item.result || item.preview} className={`w-full h-full object-cover ${item.status === 'SYNCING' ? 'brightness-50 blur-sm' : ''}`} />
                                            
                                            {item.status === 'SYNCING' && (
                                                <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/60 p-4">
                                                    <div className="w-full h-1 bg-[#ccff00]/20 overflow-hidden mb-2">
                                                        <div className="h-full bg-[#ccff00] animate-shimmer w-1/2"></div>
                                                    </div>
                                                    <span className="text-[8px] font-black tracking-widest">SYNCING...</span>
                                                </div>
                                            )}

                                            <div className="absolute top-2 right-2 text-[8px] px-2 py-1 font-bold bg-[#ccff00] text-black">
                                                {item.status}
                                            </div>
                                            
                                            <div className="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black opacity-0 group-hover:opacity-100 transition-all flex gap-2">
                                                <button onClick={() => setFileQueue(q => q.filter(it => it.id !== item.id))} className="p-2 bg-red-600 text-white"><Icon name="trash-2" className="w-3 h-3"/></button>
                                                {item.result && <a href={item.result} download={item.originalName} className="flex-1 bg-white text-black text-[9px] font-bold flex items-center justify-center"><Icon name="download" className="w-3 h-3 mr-1"/> EXPORT</a>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>
                    </main>

                    {/* Drag Overlay */}
                    {isDragging && (
                        <div className="fixed inset-0 z-[100] bg-[#4c1d95]/80 backdrop-blur-xl flex items-center justify-center p-10">
                            <div className="w-full h-full border-4 border-[#ccff00] border-dashed flex flex-col items-center justify-center">
                                <Icon name="zap" className="w-20 h-20 mb-4 animate-bounce" />
                                <h2 className="text-4xl font-black italic tracking-tighter">BIO-DATA DETECTED</h2>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>