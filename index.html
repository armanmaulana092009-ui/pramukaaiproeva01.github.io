import React, { useState, useEffect, useRef } from 'react';
import JSZip from "jszip";
import {
  Upload, ShieldCheck, Download, RefreshCw, CheckCircle2, Users,
  Trash2, Zap, Cpu, Activity, Terminal, FileArchive
} from 'lucide-react';

const apiKey = import.meta.env.VITE_GEMINI_API_KEY;

const App = () => {
  const [fileQueue, setFileQueue] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [selectedLevel, setSelectedLevel] = useState('Penggalang');
  const [editType, setEditType] = useState('full');
  const [bgColor, setBgColor] = useState('hijau');
  const [isDragging, setIsDragging] = useState(false);
  const [isZipping, setIsZipping] = useState(false);
  const processingRef = useRef(false);

  const levels = [
    { name: 'Siaga', ringPrompt: 'Green Metal Ring (Ring Kaleng Hijau) with Gold Tunas Kelapa emblem', color: '#16a34a' },
    { name: 'Penggalang', ringPrompt: 'Red Metal Ring (Ring Kaleng Merah) with Gold Tunas Kelapa emblem', color: '#dc2626' },
    { name: 'Penegak', ringPrompt: 'Yellow Metal Ring (Ring Kaleng Kuning) with Gold Tunas Kelapa emblem', color: '#eab308' },
    { name: 'Pembina', ringPrompt: 'Silver Metal Ring (Ring Kaleng Perak) with Gold Tunas Kelapa emblem', color: '#94a3b8' }
  ];

  const backgroundColors = [
    { id: 'hijau', name: 'Hijau', hex: '#00b140' },
    { id: 'merah', name: 'Merah', hex: '#db1514' },
    { id: 'biru', name: 'Biru', hex: '#0056b3' },
    { id: 'netral', name: 'Netral', hex: '#f5f5f4' },
  ];

  const processFiles = (files) => {
    const uploadedFiles = Array.from(files);
    uploadedFiles.forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onloadend = () => {
        if (typeof reader.result === 'string') {
          setFileQueue(prev => [...prev, {
            id: Math.random().toString(36).substr(2, 9),
            originalName: file.name,
            preview: reader.result,
            base64: reader.result.split(',')[1],
            status: 'READY',
            result: null
          }]);
        }
      };
      reader.readAsDataURL(file);
    });
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setIsDragging(false);
    processFiles(e.dataTransfer.files);
  };

  const processSingleFile = async (item) => {
    let bgPrompt = bgColor === 'hijau' ? "solid green screen background" : `solid ${bgColor} background`;
    const ringDetail = levels.find(l => l.name === selectedLevel)?.ringPrompt || "standard scout ring";

    const prompt = `High-end studio photography, 4k resolution. 
      Core Task: Change background to ${bgPrompt}. 
      Mandatory Attire: ${editType === 'full' 
        ? 'Indonesian Scout Uniform (Seragam Pramuka Cokelat), with a Red-and-White Scout Scarf (Kacu Merah Putih)' 
        : 'Keep original clothes, but add a Red-and-White Scout Scarf (Kacu Merah Putih) around the neck'}. 
      Specific Accessory: Add a ${ringDetail} to secure the scarf. 
      Color Accuracy: The scarf MUST be strictly Red and White (half red, half white), no yellow or other colors allowed. 
      Final Polish: Cinematic lighting, professional retouching, maintaining person's facial features accurately.`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: item.base64 } }] }],
          generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
        })
      });
      const result = await response.json();
      const base64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
      return base64 ? { status: 'COMPLETE', result: `data:image/png;base64,${base64}` } : { status: 'ERROR', error: 'AI Error' };
    } catch (e) {
      return { status: 'ERROR', error: e.message };
    }
  };

  const startBatch = async () => {
    setIsProcessing(true);
    processingRef.current = true;
    for (const item of fileQueue) {
      if (item.status === 'COMPLETE' || !processingRef.current) continue;
      setFileQueue(q => q.map(i => i.id === item.id ? { ...i, status: 'SYNCING' } : i));
      const res = await processSingleFile(item);
      setFileQueue(q => q.map(i => i.id === item.id ? { ...i, ...res } : i));
    }
    setIsProcessing(false);
  };

  const handleZipDownload = async () => {
    setIsZipping(true);
    const zip = new JSZip();
    const completedItems = fileQueue.filter(item => item.status === 'COMPLETE' && item.result);

    completedItems.forEach((item) => {
      const base64Data = item.result.split(',')[1];
      zip.file(`processed_${item.originalName}`, base64Data, { base64: true });
    });

    try {
      const content = await zip.generateAsync({ type: "blob" });
      const url = window.URL.createObjectURL(content);
      const link = document.createElement('a');
      link.href = url;
      link.download = `PramukaAI_Batch_${new Date().getTime()}.zip`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error("ZIP Generation failed", err);
    } finally {
      setIsZipping(false);
    }
  };

  const hasCompletedFiles = fileQueue.some(item => item.status === 'COMPLETE');

  return (
    <div 
      onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
      onDragLeave={() => setIsDragging(false)}
      onDrop={handleDrop}
      className="min-h-screen transition-all duration-500 font-mono bg-[#0a0510] text-[#ccff00] selection:bg-[#ccff00]/30 overflow-x-hidden"
    >
      {/* Konten utama dan UI lainnya sama seperti kode sebelumnya */}
      {/* Bisa langsung pakai seluruh JSX dari kode asli */}
    </div>
  );
};

export default App;